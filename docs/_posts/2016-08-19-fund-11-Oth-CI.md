---
layout: page
title: Continuous Integration with Jenkins
category: FundOth
order: 2
---

### Continuous Integration with Jenkins ###

### Pre-Requisite: ###

- Completion of the "Set up Parts Unlimited MRP with Jenkins" [https://microsoft.github.io/PartsUnlimitedMRP/fundoth/fund-10-Oth-prereq.html](https://microsoft.github.io/PartsUnlimitedMRP/fundoth/fund-10-Oth-prereq.html)
- An Active Azure Subscription (You can open a trial subscription here: [https://azure.microsoft.com/en-us/free](https://azure.microsoft.com/en-us/free))
- A tool to connect to a Linux vm using SSH (like Putty for example: [http://www.chiark.greenend.org.uk/~sgtatham/putty/](http://www.chiark.greenend.org.uk/~sgtatham/putty/)) 
- Have a github account [https://github.com](https://github.com).
- Have an Oracle account for the JDK. 

    If you need an account, you can create one from here: [http://jenkins-ci.org/oracleAccountSignup](http://jenkins-ci.org/oracleAccountSignup). 

    **Note**: You may recieve a message indicating that the Oracle site is experiencing difficulties, don't worry about this and proceed to the rest of the lab.

### Tasks Overview:
During the following tasks you will fork the PartsUnlimitedMRP github repository and create a Jenkins pipeline for the Continous Integration of the Parts Unlimited MRP application. You will learn how to configure Jenkins so that whenever a change is checked in on the code repository, a build will be triggered and several tests will be performed.

### Task 1: Configure your GitHub repository

**1.** Nagivate to [https://github.com/Microsoft/PartsUnlimitedMRP/](https://github.com/Microsoft/PartsUnlimitedMRP/)

**2.** Sign in with your github account

**3.** Click on Fork and select your account.

![Github fork](<../assets/jenkins/github_fork.png>)

**4.** Go to the forked repository and click on **Settings**

**5.** Click on Webhooks then **Add webhook**

![Github Webhook](<../assets/jenkins/github_webhook.png>)

**6.** Type the following in the **Payload URL**

```
http://jenkins:Passw0rd@fqdn_of_your_jenkinsmaster:8080/job/PartsUnlimitedMRP/build
```
**NOTE:** You can use the IP or the FQDN of your jenkins master server

**7.** Click **Add webhook** 

**8.** Navigate to 
```
http://fqdn_of_your_jenkinsmaster:8080/configureSecurity/
```

**9.** Check the box "Allow anonymous read access"

**10.** Untick the box "Prevent Cross Site Request Forgery exploits" and click **Save** 

![CSRF_disabled](<../assets/jenkins/csrf_disabled.png>)

This will Disable the CSRF protection on the Jenkins master but is an easy way to enable CI with Github.


### Task 2: Configure Jenkins  
The three tools that we will need to create our pipeline on Jenkins needs to be configured on our instance of Jenkins.

Connect to the Jenkins master that you have configure in the previous lab using port 8080:
```
http://fqdn_of_your_jenkinsmaster:8080/manage 
```

**1.** Configure the JDK

Go to the **Global Tool Configuration**

![Global Tool Configuration](<../assets/jenkins/jenkins_globaltoolconfig.png>)

In order to build the Parts Unlimited application we need to have the JDK installed.

Click on **Add JDK**

![Add JDK](<../assets/jenkins/jenkins_addjdk.png>)

* Type the friendly name for the JDK: "JDK 8"
* Check the box "Install automatically"
* In the drop-down list, select the latest version ("Java SE Development Kit 8u112" at the time of writing)
* Check the box "I agree to the Java SE Development Kit License Agreement"
* Click on the link to enter the username and password of your Oracle account (Check the link in the pre-requisites)
* Click **Save**

![JDK Installation](<../assets/jenkins/jdk_installer.png>)


**2.** Configure Gradle 

Go to the **Global Tool Configuration**

Gradle will be used to build the Parts Unlimited application. If needed, you could use Maven or Ant as well, the configuration would be very similar.

Click on **Add Gradle** 

![Add Gradle](<../assets/jenkins/jenkins_addgradle.png>)

* Type the friendly name fo this installation of Gradle: "Gradle"
* Verify that the "Install automatically" box is checked
* Select the latest version of Gradle in the drop-down list.
* Click **Save**

![Gradle Installation](<../assets/jenkins/gradle_installer.png>)


### Task 3: Create a new pipeline
In this task, we will create a new pipeline that will build the artifacts of the application.

**1.** Create an empty pipeline: from you Jenkins master, click on **New Item**.

![New Jenkins item](<../assets/jenkins/jenkins_newitem.png>)

* Type the following name for the pipeline: **PartsUnlimitedMRP**
* Select **Pipeline** 
* Click **OK**

![New Jenkins Pipeline](<../assets/jenkins/jenkins_newpipeline.png>)

The pipeline type in Jenkins will allow us to describe all the build step with Groovy code. This code can be easily ported on any Jenkins system and could also be embeded in a Jenkinsfile in the source code.

**2.** Create the Pipeline

Click on the tab name **Pipeline** and ensure that the definition is **Pipeline script**

The following code will clone the source code from PartsUnlimited, define the environement variables for the JDK and print the version of Java that we are using. Copy the script below in the **Script** box. 

{% highlight groovy %}
node{
    stage ("Checkout") {
    git 'https://github.com/Microsoft/PartsUnlimitedMRP.git'
    }

    env.JAVA_HOME = "${tool 'JDK 8'}"
    env.PATH = "${env.JAVA_HOME}/bin:${env.PATH}"
    sh 'java -version'
}
{% endhighlight %}

Replace the git url with the url of your own github repository. 

![Pipeline script](<../assets/jenkins/pipeline_script1.png>)

The **stage** syntax in the code above defines a boundary of code that will be executed together. In a pipeline you can have as many stages as you want, they can run sequencially or in parallell, depending on the constraints that you have to build the application.

Click **Save** and then **Build Now** 

![Pipeline script](<../assets/jenkins/pipeline_build1.png>)

After few seconds you should have a successfull build with following result:

![Build results](<../assets/jenkins/build_result1.png>)

**3.** Building PartsUnlimitedMRP

Now that we have a basic pipelinem, let's add the code that will define the build of the Parts Unlimited application.
The application is composed of three components: 
- The _Order Service_
- The _Integration Service_
- The _Client_ application 

we will create a stage for each of those components.

Copy the following code in the pipeline script: 

{% highlight Groovy %}

node{
    stage ("Checkout") {
    git 'https://github.com/Microsoft/PartsUnlimitedMRP.git'
    }
    env.JAVA_HOME = "${tool 'JDK 8'}"
    env.PATH = "${env.JAVA_HOME}/bin:${env.PATH}"
    sh 'java -version'    
    stage ("Integration Service") {
            dir('src/Backend/IntegrationService') {
            sh 'chmod +x gradlew'
            sh './gradlew build'
            archiveArtifacts artifacts: '**/integration-service*.jar', excludes: null
        }
    }    
    stage ("Order Service") {
            dir('src/Backend/OrderService') {
            sh 'chmod +x gradlew'
            sh './gradlew build'
            archiveArtifacts artifacts: '**/ordering-service*.jar', excludes: null
        }
    }    
    stage ("Clients") {
        dir('src/Clients') {
            sh 'chmod +x gradlew'
            sh './gradlew build'
            archiveArtifacts artifacts: '**/mrp.war', excludes: null
        }
    }
}

{% endhighlight %}

Replace the git url with the url of your own github repository. 

Click **Save** and then **Build Now**
You may have to refresh the page once the build has completed to see the artifacts that have been produced.

![Build Pipeline for PartsUnlimitedMRP](<../assets/jenkins/build_pipeline2.png>)


### Task 4: Adding test coverage
The Parts Unlimited MRP Application performs some test for the OrderService component. In this task, we will add some information about the results of those tests and display the trend of the results of those tests.

**1.** Cick on **Configure** to edit your pipleline script.

**2.** After line 22, insert the following code
            ```
            junit '**/TEST-*.xml'
            ```

The new pipeline code is:

{% highlight Groovy %}

node{
    stage ("Checkout") {
    git 'https://github.com/Microsoft/PartsUnlimitedMRP.git'
    }
    env.JAVA_HOME = "${tool 'JDK 8'}"
    env.PATH = "${env.JAVA_HOME}/bin:${env.PATH}"
    sh 'java -version'    
    stage ("Integration Service") {
            dir('src/Backend/IntegrationService') {
            sh 'chmod +x gradlew'
            sh './gradlew build'
            archiveArtifacts artifacts: '**/integration-service*.jar', excludes: null
        }
    }    
    stage ("Order Service") {
            dir('src/Backend/OrderService') {
            sh 'chmod +x gradlew'
            sh './gradlew build'
            archiveArtifacts artifacts: '**/ordering-service*.jar', excludes: null
            junit '**/TEST-*.xml'
        }
    }    
    stage ("Clients") {
        dir('src/Clients') {
            sh 'chmod +x gradlew'
            sh './gradlew build'
            archiveArtifacts artifacts: '**/mrp.war', excludes: null
        }
    }
}

{% endhighlight %}

**3.** Click on **Save** then **Build Now**

The test results will be displayed on the top of the pipleline page.

![Pipeline with test results](<../assets/jenkins/pipeline_withtest.png>)



Next steps
----------

In this lab, you learned how to create a Continuous Integration build that runs when new commits are pushed to the master branch. This allows you to get feedback as to whether your changes made breaking syntax changes, or if they broke one or more automated tests, or if your changes are okay. Try these lab out for next steps:

- [Parts Unlimited MRP Continous Deployment](https://microsoft.github.io/PartsUnlimitedMRP/fundoth/fund-12-Oth-CD.html)


# Continuous Feedbacks

#### Issues / Questions about this HOL ??

[If you are encountering some issues or questions during this Hands on Labs, please open an issue by clicking here](https://github.com/Microsoft/PartsUnlimitedMRP/issues)

Thanks
